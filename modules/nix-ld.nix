# ============================================================================== #
#                                                                                #
#   Nix-ld — Запуск pre-compiled бинарников                                      #
#                                                                                #
# ============================================================================== #
#
#   ЧТО ЭТО?
#   ─────────────────────────────────────────────────────────────────────────────
#   NixOS не имеет стандартного динамического линковщика (/lib64/ld-linux-x86-64.so.2),
#   который ожидают бинарники, скомпилированные для обычного Linux.
#
#   nix-ld предоставляет этот линковщик, позволяя запускать:
#   • LSP серверы, которые скачивают IDE (Zed, VS Code)
#   • Pre-compiled бинарники из npm, cargo, pip
#   • Проприетарное ПО без Nix-пакета
#
#   ДИАГНОСТИКА:
#   ─────────────────────────────────────────────────────────────────────────────
#   Если бинарник не запускается с ошибкой "cannot execute binary file":
#   1. file /path/to/binary — проверить тип файла
#   2. ldd /path/to/binary — показать недостающие библиотеки
#   3. Добавить недостающие библиотеки в libraries ниже
#
# ============================================================================== #
{ config, lib, pkgs, ... }:

{
  programs.nix-ld = {
    enable = true;  # Отключить: enable = false

    # ── Библиотеки для динамически слинкованных бинарников ────────────────────
    # Добавляй сюда библиотеки, если бинарник жалуется на их отсутствие
    libraries = with pkgs; [
      # Базовые (нужны почти всегда)
      stdenv.cc.cc.lib       # libstdc++, libgcc_s
      zlib                   # libz.so (сжатие)

      # Сеть и криптография
      openssl                # libssl, libcrypto
      curl                   # libcurl

      # Системные
      glib                   # libglib, libgobject
      nss                    # libnss (Mozilla SSL)
      nspr                   # libnspr (Mozilla runtime)

      # Графика (для GUI приложений)
      xorg.libX11            # libX11
      xorg.libXcursor        # libXcursor
      xorg.libXrandr         # libXrandr
      libGL                  # libGL (OpenGL)
    ];
  };
}
